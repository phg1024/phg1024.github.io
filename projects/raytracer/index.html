<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/style.css">

        <!-- MathJax -->
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
            });
        </script>

        <!-- jQuery -->
        <script type="text/javascript" src="/lib/jquery-1.10.2.min.js"></script>

        <!-- My own script -->
        <script type="text/javascript" src="/js/phgscript.js"></script>
    </head>
    <body>
        <div id="main">
	        <header>
	            <h1 class="title"><a href="/">Peihong's Infinite Dimensional Space</a></h1>
	        </header>
			
          <nav role="navigation">
			  <ul>
            <li><a href="/">home</a></li>
            <li><a href="/projects">projects</a></li>
            <li><a href="/blog.html">blog</a></li>
            <li><a href="/about.html">about</a></li>
            <li><a href="/contact.html">contact</a></li>
		      </ul>
          </nav>

          <link rel='stylesheet' type='text/css' href='../projects.css' media="screen, print, projection">
<link rel='stylesheet' type='text/css' href='./style.css' media="screen, print, projection">

    <script type='text/javascript' src='shape.js'></script>
    <script type='text/javascript' src='image.js'></script>
    <script type='text/javascript' src='utils.js'></script>
    <script type='text/javascript' src='point.js'></script>
    <script type='text/javascript' src='vector.js'></script>
    <script type='text/javascript' src='mesh.js'></script>
    <script type='text/javascript' src='raytracer.js'></script>
    <script type='text/javascript' src='FileSaver.js'></script>
    <script type='text/javascript' src='canvas-toBlob.js'></script>
    <script type='text/javascript'>
        function resize()
        {
            var w = document.getElementById('width').value;
            var h = document.getElementById('height').value;
            canvas.setAttribute('width', w);
            canvas.setAttribute('height', h);
        }

        var canvas;
        var ctx;
        var finishedCount;
        var startT, endT;
        var progress;

        function init()
        {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
        }

        function render() {

//            if (typeof window.FileReader !== 'function') {
//                write("The file API isn't supported on this browser yet.");
//                return;
//            }

            //var m = new Mesh('cube.obj', Color.BLUE, {Ka:0.1, Kd:0.6, Ks:0.3, fr: 0.25});
            //console.log(m);

            startT = new Date();

            var w = canvas.width;
            var h = canvas.height;
            ctx.clearRect ( 0, 0, w, h );

            var nsamples = document.getElementById('nsamples').value;
            var maxDepth = document.getElementById('maxdepth').value;
            var nthreads = document.getElementById('threads').value;
            finishedCount = 0;

            progress = [];
            for(var tid=0;tid<nthreads;tid++)
                progress.push(0);

            var yStep = Math.floor(h / nthreads);
            var y1 = 0, y2 = yStep;
            for( var i=0;i<nthreads;i++ )
            {
                if( i === nthreads - 1 )
                {
                    y2 = h;
                }

                var worker = new Worker('renderWorker.js');

                worker.onmessage = function (e) {
                    var data = e.data;
                    switch (data.msg) {
                        case 'progress':
                        {
                            progress[data.tidx] = data.value;

                            document.getElementById("progress").innerHTML='Rendering in progress: ' + progress.mean().toFixed(2) + '%';
                            break;
                        }
                        case 'image':
                        {
                            // assemble the image and show it
                            updateCanvas( data.y1, data.y2, data.value );
                            this.terminate();
                            break;
                        }
                    }
                };
                worker.postMessage({cmd: 'start', tidx: i, w: w, h: h, y1: y1, y2: y2, nsamples: nsamples, maxDepth: maxDepth});

                y1 = y1 + yStep;
                y2 = y2 + yStep;
            }
        }

        function updateCanvas(y1, y2, buffer) {
            var w = canvas.width;
            var h = canvas.height;

            var img = new RGBAImage(0, 0);
            img.w = w;
            img.h = y2-y1;
            img.data = new Uint8Array(buffer);
            ctx.putImageData(img.toImageData(ctx), 0, h-y2, 0, 0, img.w, img.h);

            finishedCount++;

            if( finishedCount == document.getElementById("threads").value )
            {
                endT = new Date();
                var diff = endT - startT;
                console.log( diff + 'ms' );
                document.getElementById("progress").innerHTML = 'Finished in ' + diff + ' ms.';
            }
        }

        function saveImage() {
            // save the image
            canvas.toBlob(function(blob) {
                saveAs(blob, "renderedImage.png");
            });
        }

        window.onload = init;
    </script>

    <div class="content">
        <h2>JavaScript Ray Tracer</h2>
        <div>
            <canvas id='canvas' width='480px' height='320px'></canvas>
        </div>
        <button id='renderButton' onclick='render()'>Render</button>
        <button id='saveButton' onclick='saveImage()'>Save</button>
        <button id='resizeButton' onclick='resize()'>Resize</button>
        Width: <input id='width' type='textfield' size="4" value=480>&nbsp
        Height: <input id='height' type='textfield' size="4" value=320><br>
        Number of samples: <input id='nsamples' type='textfield' size="4" value=4>&nbsp
        Maximum depth: <input id='maxdepth' type='textfield' size="4" value=2>
        Threads: <input id='threads' type='textfield' size="4" value=2><br>

        <p id="progress"></p>
    </div>


          <footer>
          &copy 2009-2013 &nbsp Peihong Guo &nbsp 
   	    <script type="text/javascript">
   		    writeEmailAddress();
           </script>
           </footer>

       </div>
    </body>
</html>
